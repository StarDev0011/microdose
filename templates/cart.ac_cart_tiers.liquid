{% layout none %}{% capture results %}{% assign customerTag = '' %}{% if customer %}{% for tag in customer.tags %}{% if tag contains "acp_" %}{% assign customerTag = tag %}{% break %}{% endif %}{% endfor %}{% endif %}{% for item in cart.items %}{ "product_id": {{item.product_id}}, "variant_id": {{item.variant.id }}, {% assign checkAutTag = false %}{% assign CartProductTags = item.product.metafields.ACPTiered.CustomerTiers.value | default: nil  %}{% if CartProductTags == null %}{% assign CartProductTags = item.product.metafields.ACPTiered.CustomerTiers %}{% endif %}{% assign CartProductTags =  CartProductTags  | map: 'tag' %}{% assign _CustTags = customer.tags  %}{% assign _ShopTags = shop.metafields.ACPTiered.Tags.value.Tags  %}{% assign newCustomerTagList = '' %}{% for _tag in _ShopTags %}{% if _CustTags contains _tag %}{% assign newCustomerTagList = newCustomerTagList | append: ',' | append: _tag %}{% endif %}{% endfor %}{% assign newCustomerTagList = newCustomerTagList | split: ',' %}{% for tag in newCustomerTagList %}{% if tag contains "acp_" %}{%else%}{% if CartProductTags contains tag %}{% assign checkAutTag = true %}{%assign customerTag = tag %}{%break%}{% endif %}{% endif %}{% endfor %}{% if checkAutTag == false %}{% for tag in customer.tags %}{% if tag contains "acp_" %}{% assign customerTag = tag %}{% break %}{% endif %}{% endfor %}{% endif %} {% assign tempCustomerTierCart = item.product.metafields.ACPTiered.CustomerTiers.value | where: "tag", customerTag | default: nil  %}{% if customerTag != '' and tempCustomerTierCart %} "tiers" : [{{tempCustomerTierCart[0]['tier'] | json}}] {% else %} "tiers" : {{item.product.metafields.ACPTiered.NormalTiers.value | default: '[]' | json}}{% endif %}  }{% unless forloop.last %},{% endunless %} {% endfor %}{% endcapture %}[{{results}}]